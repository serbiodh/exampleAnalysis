---
title: "IDE analysis"
author: "Sergio Diez Hermano"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  html_document:
      highlight: tango
      toc: yes
      toc_depth: 4
      toc_float:
        collapsed: no
---

```{r setup, echo=FALSE, warning = FALSE, message = FALSE}
suppressMessages(require(knitr))
# include this code chunk as-is to set options
opts_chunk$set(comment = NA, prompt = FALSE, fig.height=5, fig.width=5, dpi=300, fig.align = "center", echo = FALSE, message = FALSE, warning = FALSE, cache=FALSE)
Sys.setenv(RSTUDIO_PANDOC = "C:/Program Files/Pandoc")
```

```{r, echo=FALSE}
# Load libraries
suppressMessages(Sys.setlocale("LC_TIME", "C"))
suppressMessages(library(ggplot2))
suppressMessages(library(GGally)) #ggpairs
suppressMessages(library(RColorBrewer))
suppressMessages(library(pca3d))
suppressMessages(library(pcaMethods))
suppressMessages(library(pls))
suppressMessages(library(rgl)) #plot3d
suppressMessages(library(rstatix)) #outlier multivariate
suppressMessages(rgl::setupKnitr(autoprint = T))

```

```{r, echo=FALSE}
# Load data
ideDat <- read.csv("IDE_Fasting-Refeeding_HFD_Mice_reformat.csv", sep=";")
colnames(ideDat)[3] <- "Nut.Stat"
ideDat$expGroup <- interaction(ideDat$Nut.Stat, ideDat$Diet)

# Remove outlier with big activity in muscle
ideDat <- ideDat[-which(ideDat$actmuscle > 0.7), ]

```

# Consideraciones iniciales

```{r, echo=FALSE}
tableList <- lapply(ideDat[,17:25], function(x) aggregate(x ~ ideDat$expGroup, data=ideDat, length))
countFrame <- do.call(cbind, tableList)
countFrame <- countFrame[, c(1, seq(2,18,2))]
colnames(countFrame) <- c("Group", colnames(ideDat[,17:25])) 
```

- **Variables independientes** consideradas: `r colnames(ideDat[,8:15])`

- **Variables respuesta** consideradas:
  - De cada órgano: rna (mRNA), prot (proteína) y act (actividad)
    - `r colnames(ideDat[,17:19])`
    - `r colnames(ideDat[,20:22])`
    - `r colnames(ideDat[,23:25])`

- Los **tamaños muestrales** actuales son:

```{r, echo=FALSE}
kable(countFrame)
```

Teniendo esto en cuenta, a continuación se presenta:

- <u>Boxplot para el peso y la ingesta calórica</u>, para comprobar que no hay sesgos experimentales inesperados.

- <u>Gráficos 3D que enfrenta mRNA, proteína y actividad de IDE</u>, para comprobar visualmente si hay algún tipo de patrón o separación evidente entre las condiciones experimentales. 

  - <u>Anova multivariante (MANOVA) y gráficos de interacción</u> que comparan el efecto de las condiciones experimentales en el mRNA, proteínas y actividad.
  
- Regresiones parciales que analizan el efecto de las 8 variables independientes sobre cada variable respuesta (mRNA, proteína, actividad), basada en Análisis de Componentes Principales (<u>PLSR-PCA, *partial least square regression - principal component analysis*</u>).


# Group vs Calories and Weight

El peso parece distribuirse uniformemente y de forma esperable entre las condiciones experimentales. La ingesta calórica de los ratones HFD.RF30min tiene una dispersión elevada en comparación con el resto de grupos, quizá sería conveniente explicar el posible origen de esta variabilidad.

```{r, echo=FALSE, out.width="50%"}

# Body weight
weight_bx <- ggplot(ideDat, aes(expGroup, Body.weight)) +
    geom_boxplot() +
    theme_bw(16)
weight_bx +
   geom_jitter(width=0.15)+
    theme(axis.text.x = element_text(angle = 45, hjust=1))

# Caloric intake rate
caloric_bx <- ggplot(ideDat, aes(expGroup, Caloric.Intake.Rate)) +
    geom_boxplot() +
    theme_bw(16)
caloric_bx +
   geom_jitter(width=0.15)+
    theme(axis.text.x = element_text(angle = 45, hjust=1))


```


# mRNA vs Protein vs Activity

Se representa la relación entre la cantidad de mRNA, proteína y la actividad de IDE, en cada uno de los tres órganos. Los gráficos pueden rotarse. Buscad si visualmente ocurren cosas que se esperan (si hay más proteína cuando hay más mRNA, o más actividad), o si hay alguna agrupación que diferencie claramente una condición experimental de otra. Esto se cuantifica mejor en el siguiente apartado "MANOVA".

```{r, fig.width=2.5, fig.height=2.5, echo=FALSE}
# Color vectors
# sdCol <- rep(brewer.pal(9, "YlOrRd")[5:7], times = table(ideDat$expGroup)[4:6])
# hfdCol <- rep(brewer.pal(9, "YlGnBu")[5:7], times = table(ideDat$expGroup)[1:3])
sdCol <- rep(c("cyan", "dodgerblue", "blue4"), times = table(ideDat$expGroup)[4:6])
hfdCol <- rep(c("orange", "orangered", "red4"), times = table(ideDat$expGroup)[1:3])
# Add to data frame
ideDat$colVec <- c(sdCol, hfdCol)

#Plot
# cc<- palette()
# par(cex.axis=0.5, mfrow3d(1,3, sharedMouse = FALSE))
par3d(windowRect = c(100, 100, 612, 612))
ide.noNA <- na.omit(ideDat[, c(17:19, 26, 27)])
plot3d(ide.noNA[,1], ide.noNA[,2], ide.noNA[,3], col=ide.noNA$colVec, type = "s", size = 1,
       main = "Liver", xlab = "mRNA", ylab = "Protein", zlab = "Activity", axes=T)
legend3d("top", legend = unique(ideDat$expGroup), ncol= 2, pch = 16, col = unique(ideDat$colVec), cex=0.8, inset=c(0))

par3d(windowRect = c(100, 100, 612, 612))
ide.noNA <- na.omit(ideDat[, c(20:22, 26, 27)])
plot3d(ide.noNA[,1], ide.noNA[,2], ide.noNA[,3], col=ide.noNA$colVec, type = "s", size = 1,
       main = "Kidney", xlab = "mRNA", ylab = "Protein", zlab = "Activity", axes=T)
legend3d("top", legend = unique(ideDat$expGroup), ncol= 2, pch = 16, col = unique(ideDat$colVec), cex=0.8, inset=c(0))

par3d(windowRect = c(100, 100, 612, 612))
ide.noNA <- na.omit(ideDat[, c(23:25, 26, 27)])
plot3d(ide.noNA[,1], ide.noNA[,2], ide.noNA[,3], col=ide.noNA$colVec, type = "s", size = 1,
       main = "Muscle", xlab = "mRNA", ylab = "Protein", zlab = "Activity", axes=T)
legend3d("top", legend = unique(ideDat$expGroup), ncol= 2, pch = 16, col = unique(ideDat$colVec), cex=0.8, inset=c(0))

```

## MANOVA

A continuación se presenta el <u>análisis conjunto de las variables respuesta (mRNA, proteína y actividad) y las diferencias significativas detectadas entre condiciones experimentales</u>. 

Para ello se ha llevado a cabo un **Anova Multivariante o MANOVA**, que ha dado como resultado que <u>hay diferencias en las variables debidas a las condiciones experimentales (p < 0.01)</u>. Podéis ver dónde están esas diferencias en los gráficos de interacción que aparecen debajo, que representan las medias y las desviaciones:

- Columna 1: Hígado
- Columna 2: Riñón
- Columna 3: Músculo

- Fila 1: mRNA
- Fila 2: Proteína
- Fila 3: Actividad

Comparad aquellos intervalos que no se solapen, son los responsables de las diferencias significativas. Las comparaciones hay que hacerlas en dos sentidos:

- Dentro de cada estado nutricional, se compara <span style="color: red;">HFD (rojo)</span> vs <span style="color: blue;">SD (azul)</span)
- Dentro de cada tipo de dieta, se comparan estados nutricionales (<span style="color: red;">rojos vs rojos</span> y <span style="color: blue;">azules vs azules</span>).

Para explicar esto en el artículo, sugiero señalar únicamente el p-valor del test omnibus (el MANOVA general que he comentado antes) y mostrar los gráficos, sin p-valores adicionales de comparaciones múltiples, a menos que los pidan los revisores. A lo sumo, para cada gráfico, se podría dar un p-valor adicional que indique si al menos una de las medias es diferente a las demás.


```{r, include=FALSE}
# https://web.archive.org/web/20171108194414/http://goanna.cs.rmit.edu.au/~fscholer/anova.php
# http://www.sthda.com/english/wiki/two-way-anova-test-in-r

manLiver <- manova(cbind(rnaliver, protliver, actliver) ~ Diet*Nut.Stat, data = ideDat)
summary(manLiver)
summary.aov(manLiver)

interaction.plot(ideDat$Nut.Stat, ideDat$Diet, ideDat$rnaliver, type="b", col=c(1,2),
   leg.bty="o", leg.bg="beige", lwd=2, pch=c(18,24,22),
   xlab="Number of Cylinders",
   ylab="Mean Miles Per Gallon",
   main="Interaction Plot")

Anova(lm(rnaliver ~  Diet + Nut.Stat, data=ideDat, contrasts=list(Diet=contr.sum, Nut.Stat=contr.sum)), type=3)
Anova(lm(protliver ~  Diet*Nut.Stat, data=ideDat, contrasts=list(Diet=contr.sum, Nut.Stat=contr.sum)), type=3)
Anova(lm(actliver ~  Diet + Nut.Stat, data=ideDat, contrasts=list(Diet=contr.sum, Nut.Stat=contr.sum)), type=3)

```

```{r, fig.width=15, fig.height=15, echo = FALSE}
library(sjPlot)
library(sjmisc)
library(ggplot2)
library(emmeans)
theme_set(theme_sjplot())

modList <- list()
plotList <- list()
sumdietList <- list()
sumnutList <-list()

for (j in c("rna", "prot", "act")) {
  
  for (h in c("liver", "kidney", "muscle")) {
    
    vbl <- j
    organ <- h
    formMod <- as.formula(paste(paste(vbl, organ, sep=""), "~ Nut.Stat*Diet"))
    
    mod <- lm(formMod, data=ideDat, contrasts=list(Diet=contr.sum, Nut.Stat=contr.sum))
    modList[[paste(vbl, organ, sep="")]] <- mod
    plotList[[paste(vbl, organ, sep="")]] <- plot_model(mod, type="int")
    sumdietList[[paste(vbl, organ, sep="")]] <- summary(pairs(emmeans(mod, ~ Nut.Stat | Diet, adjust="sidak")))
    sumnutList[[paste(vbl, organ, sep="")]] <- summary(pairs(emmeans(mod, ~ Diet | Nut.Stat, adjust="sidak")))
    
  }
  
}

ggpubr::ggarrange(plotlist = plotList, nrow=3, ncol = 3, common.legend = T)
```

# PLSR-PCA

Este análisis permite analizar la influencia conjunta de las variables independientes fisiológicas sobre las variables respuesta, y cómo afectan a la organización de las condiciones experimentales. 

No devuelve p-valores porque es un análisis gráfico, que permite representar los datos en nuevas dimensiones que maximizan la variabilidad capturada. 

En los siguientes apartados os explico el procedimiento y cómo interpretarlo. El resultado final del análisis es el apartado "Plot PLSR".

## Scale data

Primero, se escalan todas las variables, es decir, se hace que todas tengan media = 0 y desviación = 1. Esto es imprescindible para que las diferentes unidades de medida de las variables no sesguen los resultados del análisis. Podéis ver en el boxplot que las ditribuciones resultan simétricas, y todas están centradas en 0. 

Este apartado no tiene mayor interés para vosotros.

```{r, fig.width=10, echo=FALSE}
# https://www.cienciadedatos.net/documentos/35_principal_component_analysis#

# Don't select Fat.weight
scaleDat <- as.data.frame(scale(ideDat[, c(8:15, 17:25)]))
pcaFrame <- cbind(scaleDat, expGroup = ideDat[, 26])
# pcaFrame <- na.omit(pcaFrame)
rownames(pcaFrame) <- paste(pcaFrame$expGroup, rownames(pcaFrame), sep="")
# summary(pcaFrame)
boxplot(pcaFrame[1:17], xaxt = "n", xlab = NA)
abline(v=8.5, col = "gray")
text(1:17, y = par("usr")[3] - 0.1, labels = colnames(scaleDat), xpd = NA, srt = 35, adj = 0.965)
```

## Plot profiles

En este gráfico se muestra lo que se va a analizar con la técnica PLSR-PCA. Para cada condición experimental, tenemos un **perfil de variables independientes** (a la izquierda de la barra vertical) y **tres perfiles de variables respuesta**, uno por cada órgano (derecha de la barra vertical). Cada línea une los valores de una misma observación (ratón). 

La simple inspección visual ya permite apreciar algunas diferencias, por ejemplo, para la dieta estándar SD, en la condición de Fasting toma protagonismo la variable NEFA y disminuyen los valores de Glicerol, Lactato e Insulina, sin embargo, este patrón parece invertirse para las condiciones de RF30min y RF3h.

El objetivo es ser capaz de analizar cómo estos perfiles de variables independientes, respuesta y condiciones experimentales se interrelacionan unos con otros. Eso se hace en el siguiente apartado "Plot PLSR".

```{r, fig.width=10, fig.height=18, echo=FALSE}
# Color vectors
sdCol <- rep(c("cyan", "dodgerblue", "blue4"), times = table(ideDat$expGroup)[4:6])
hfdCol <- rep(c("orange", "orangered", "red4"), times = table(ideDat$expGroup)[1:3])
# Add to data frame
pcaFrame$colVec <- c(sdCol, hfdCol)

# Plot limits
ylimUp <- ceiling(max(na.omit(scaleDat))) + 0.6
ylimDown <- floor(min(na.omit(scaleDat)))

# Groups to plot
expGroup <- unique(ideDat$expGroup)

# Plot
par(mfrow=c(6,1))

for (i in expGroup) {
  
  # Empty plot
  plot(1:17, rep(NA, 17), xaxt = "n", ylab = "Standarized value", xlab=NA, ylim=c(ylimDown, ylimUp), main = i)
  text(1:17, y = par("usr")[3] - 0.1, labels = colnames(scaleDat), xpd = NA, srt = 35, adj = 0.965)
  
  # Select group
  # groupDat <- na.omit(pcaFrame[pcaFrame$expGroup == i, ])
  groupDat <- pcaFrame[pcaFrame$expGroup == i, ]
  
  for (j in 1:dim(groupDat)[1]) {
    
    # Add line per observation (predictors)
    lines(1:8, groupDat[j, 1:8], type = "b", pch = 19, lty = 1, lwd = 1, col = groupDat[j, "colVec"])
    abline(v = 8.5)
    # Add line per response variable and organ
    # Liver
    # lines(9:17, groupDat[j, 9:17], type = "b", pch = 19, lty = 1, lwd = 1, col = groupDat[j, "colVec"])
    lines(9:11, groupDat[j, c(9:11)], type = "b", pch = 19, lty = 1, lwd = 1, col = groupDat[j, "colVec"])
    lines(12:14, groupDat[j, c(12:14)], type = "b", pch = 19, lty = 1, lwd = 1, col = groupDat[j, "colVec"])
    lines(15:17, groupDat[j, c(15:17)], type = "b", pch = 19, lty = 1, lwd = 1, col = groupDat[j, "colVec"])
  }
  
}
```

## Plot PLSR

Se presentan a continuación 9 biplot. Un biplot es una representación, en el mismo espacio dimensional, de la correlación entre:

- <span style="color: purple;">**Variable respuesta**</span> (rna, proteína, actividad) y <span style="color: darkgreen;">**variables fisiológicas**</span>. Su efecto se representa mediante <u>flechas</u>: la <span style="color: purple;">**flecha morada**</span> para la variable respuesta, las <span style="color: darkgreen;">**verdes**</span> para las fisiológicas.
- Las **condiciones experimentales**, mediante puntos que reflejan los datos reales y un <u>código de colores</u> para identificar el grupo al que pertenecen.

Cada columna corresponde a un órgano, y cada fila a una variable respuesta de IDE.

Un **ejemplo de interpretación, para el primer biplot**, sería:

- El biplot muestra la correlación entre los niveles de mRNA y las variables fisiológicas para el hígado.
- Las **variables** (flechas verdes) que *más explican los niveles de mRNA* (flecha morada) son:
    - El <u>glucagón, correlación inversa intensa</u> (se alinea con la dirección de la flecha pero en sentido contrario). Esto implica que niveles altos de mRNA de IDE en el hígado correlacionan con niveles bajos de Glucagón.
    - Los <u>triglicéridos y el colesterol, correlación directa leve o moderada</u> (se alinean débilmente con la dirección de la flecha y en el mismo sentido). Esto implica que niveles altos de mRNA de IDE en el hígado correlacionan con niveles altos de triglicéridos y colesterol, en algunos casos.
- El **resto de variables** apenas correlacionan con los niveles de mRNA (dirección casi perpendicular de las flechas verdes respecto a la morada). En concreto, el colesterol parece no participar de ninguna forma (flecha muy pequeña, casi sin separarse del centro del gráfico)
- En cuanto a las **condiciones experimentales**:
  - Se observan <u>dos cluster</u>, bien diferenciados en función de Fasting o no Fasting. 
  - El estado de Fasting, para cualquier dieta, correlaciona poco con los niveles de RNA. La variable que más les afecta es NEFA.
  - Los estados de no Fasting (RF30min y RF3h, para cualquier dieta), parecen más definidos por las variables Final.Glucose, Insulin y Lactate. Sus niveles de mRNA son mayores y más variables que los de Fasting (los puntos se orientan en el sentido de la flecha morada, pero están muy dispersos) 

También es importante detectar **cambios secuenciales entre los biplot**. Por ejemplo, en el caso del hígado, se observa cómo las variables Final.Glucose, Insulin y Lactate pasan de correlacionar muy poco con la cantidad de mRNA, para aproximarse cada vez más a la flecha morada en proteína y más aún en actividad. Es decir, en hígado, la actividad de IDE está sobre todo influenciada por estas tres variables, lo que no ocurre a nivel de mRNA y proteína. También se observa que se mantiene la separación entre Fasting-no Fasting, y que en general el resto de variables no modifican su influencia.

Esta misma interpretación habría que hacerla para cada órgano y biplot, centrándose especialmente en los patrones que resulten llamativos y que puedan explicarse a nivel fisiológico.

```{r, fig.height=20, fig.width=20, echo=FALSE}
counter <- 1

m <- matrix(c(1,1,1,2,3,4,5,6,7,8,9,10),nrow = 4,ncol = 3,byrow = TRUE)

layout(mat = m,heights = c(0.4,5,5,5))

par(mar=c(0,0,0,0))
plot(1, type = "n", axes=FALSE, xlab="", ylab="")
legend(x = "top",legend = unique(pcaFrame$expGroup), pch = 16, col = unique(pcaFrame$colVec), horiz = TRUE, bty = "n",cex=2)

par(mar = c(3.8,4.1,2,2.1), cex=1.5)

for (j in c("rna", "prot", "act")) {
  
  for (h in c("liver", "kidney", "muscle")) {
    
    vbl <- j
    organ <- h
    formMod <- as.formula(paste(paste(vbl, organ, sep=""), "~", paste0(colnames(pcaFrame[,1:8]), collapse="+")))
    pls <- plsr(formula = formMod, data = pcaFrame, scale. = F, ncomp = 3,method = "oscorespls")
    # biplot(pls.rnaliver, var.axes=T, which="x")
    
    if (counter == 1 | counter == 2 | counter == 3) {
      
      # par(xpd=TRUE)
      plot(NULL, xlim = c(-1,1), ylim = c(-1,1), axes=F, xlab="", ylab="", main = h)
      # legend(x=-1, y=1.2, ncol = 2, legend = unique(pcaFrame$expGroup), pch = 16, col = unique(pcaFrame$colVec))

    } else {
      
      plot(NULL, xlim = c(-1,1), ylim = c(-1,1), axes=F, xlab="", ylab="")
      
    }
    
    abline(h=0, lty="dashed", col="gray")
    abline(v=0, lty="dashed", col="gray")
    plotrix::draw.circle(0, 0, radius = 0.5, lty = "dashed", border = "gray")
    plotrix::draw.circle(0, 0, radius = 1, lty = "dashed", border = "gray")
    text(0.85, 0.95, vbl, cex=1.5)
    
    arrows(0, 0, pls[["Yloadings"]][1,1], pls[["Yloadings"]][1,2], col=alpha("purple", 0.6), lwd=5, length=0.1)
    # text(pls[["Yloadings"]][1,1], pls[["Yloadings"]][1,2], j, col="purple")
    for (i in 1:8) {
      arrows(0, 0, pls[["loadings"]][i,1], pls[["loadings"]][i,2], col=alpha("forestgreen", 0.6), lwd=3, length=0.1)
      # text(pls[["loadings"]][i,1], pls[["loadings"]][i,2], colnames(pcaFrame[i]), col="darkgreen")
    }
    basicPlotteR::addTextLabels(pls[["loadings"]][,1], pls[["loadings"]][,2], colnames(pcaFrame[1:8]), 
                                col.label = "darkgreen", col.line="white", avoidPoints = FALSE)
    par(new=T)
    plot(pls$scores[,1], pls$scores[,2], xlim =c(-3,3),  ylim =c(-3,3), 
         pch = 21, bg = pcaFrame[ !is.na(pcaFrame[,paste(vbl, organ, sep="")]), "colVec"], col = NA,
         xlab="PC1", ylab="PC2")
   
    
    counter <- counter + 1
  }
  
}

```
